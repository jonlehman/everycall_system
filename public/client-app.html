<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EveryCall Client Workspace</title>
  <link rel="stylesheet" href="/assets/app.css" />
</head>
<body>
  <div class="shell">
    <aside class="sidebar">
      <div class="logo">every<span>call</span></div>

      <div class="nav-group">
        <div class="nav-label">Operations</div>
        <button class="nav-btn active" data-screen="overview">Overview</button>
        <button class="nav-btn" data-screen="calls">Calls</button>
        <button class="nav-btn" data-screen="dispatch">Dispatch Board</button>
      </div>

      <div class="nav-group">
        <div class="nav-label">Setup</div>
        <button class="nav-btn" data-screen="faq">FAQ Manager</button>
        <button class="nav-btn" data-screen="team">Team Users</button>
        <button class="nav-btn" data-screen="routing">Call Routing</button>
        <button class="nav-btn" data-screen="settings">Account Settings</button>
      </div>

      <div class="sidebar-foot"></div>
    </aside>

    <main class="main">
      <div class="topbar" style="justify-content:flex-end;">
        <div class="user-chip" style="display:flex; align-items:center; gap:10px;">
          <div class="badge ok" style="border-radius:999px; padding:6px; display:flex; align-items:center; justify-content:center;">
            <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true" focusable="false" style="display:block;">
              <circle cx="12" cy="8" r="4" fill="currentColor"></circle>
              <path d="M4 20c0-3.3 3.6-6 8-6s8 2.7 8 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
            </svg>
          </div>
          <div style="text-align:right;">
            <div style="font-weight:600;" id="tenantName">Tenant</div>
            <div class="muted" style="font-size:12px;"><a href="/login.html">Sign out</a></div>
          </div>
        </div>
      </div>
      <section id="overview" class="screen active">
        <div class="topbar">
          <h1>Overview</h1>
          <div class="top-actions">
            <button class="btn">Export Today</button>
            <button class="btn brand">New FAQ</button>
          </div>
        </div>

        <div class="grid cols-4">
          <div class="card"><div class="stat">Calls Today</div><div class="value" id="statCalls">0</div></div>
          <div class="card"><div class="stat">Missed</div><div class="value" id="statMissed">0</div></div>
          <div class="card"><div class="stat">Urgent</div><div class="value" id="statUrgent">0</div></div>
          <div class="card"><div class="stat">Callbacks Due</div><div class="value" id="statCallbacks">0</div></div>
        </div>

        <div class="split" style="margin-top:12px;">
          <div class="card">
            <h2>Recent Calls</h2>
            <div class="table-wrap">
              <table class="table">
                <thead><tr><th>Time</th><th>Caller</th><th>Status</th><th>Summary</th></tr></thead>
                <tbody id="recentCallsTable"></tbody>
              </table>
            </div>
          </div>
          <div class="card">
            <h2>Action Queue</h2>
            <p class="muted">Calls requiring callback or dispatch confirmation.</p>
            <div class="kv" id="actionQueue"></div>
          </div>
        </div>
      </section>

      <section id="calls" class="screen">
        <div class="topbar">
          <h1>Call Inbox</h1>
          <div class="top-actions"><button class="btn">Refresh</button></div>
        </div>
        <div class="split">
          <div class="card">
            <table class="table" id="callsTable">
              <thead><tr><th>SID</th><th>From</th><th>When</th><th>Status</th></tr></thead>
              <tbody id="callsTableBody"></tbody>
            </table>
          </div>
          <div class="card">
            <h2>Call Detail</h2>
            <div class="code" id="callDetail">Select a call to inspect transcript, extracted fields, and routing result.</div>
          </div>
        </div>
      </section>

      <section id="dispatch" class="screen">
        <div class="topbar"><h1>Dispatch Board</h1></div>
        <div class="grid cols-3">
          <div class="card"><h2>New</h2><p><span id="dispatchNew">0</span> calls waiting assignment</p></div>
          <div class="card"><h2>Assigned</h2><p><span id="dispatchAssigned">0</span> calls in progress</p></div>
          <div class="card"><h2>Closed</h2><p><span id="dispatchClosed">0</span> completed today</p></div>
        </div>
      </section>

      <section id="faq" class="screen">
        <div class="topbar">
          <h1>FAQ Manager</h1>
          <div class="top-actions">
            <select id="industrySelect" class="btn">
              <option value="electrician">Electrician</option>
              <option value="general">General Service</option>
              <option value="hvac">HVAC</option>
              <option value="plumber">Plumber</option>
            </select>
            <button class="btn" id="seedIndustryFaqs">Add Industry Defaults</button>
            <button class="btn brand" id="addFaqBtn">Add FAQ</button>
          </div>
        </div>
        <div class="card">
          <table class="table">
            <thead><tr><th>Question</th><th>Answer</th><th>Category</th><th>Last Updated</th><th></th></tr></thead>
            <tbody id="faqTable"></tbody>
          </table>
        </div>
        <div class="card" style="margin-top:12px;">
          <div class="topbar" style="margin-bottom:8px;">
            <h2 style="margin:0;">New FAQ</h2>
            <div class="top-actions"><span class="muted" id="faqStatus">Ready.</span></div>
          </div>
          <div class="grid cols-2">
            <div>
              <label>Question</label>
              <input id="faqQuestion" placeholder="What areas do you serve?" />
              <label style="margin-top:10px;">Category</label>
              <input id="faqCategory" placeholder="Service Area" />
            </div>
            <div>
              <label>Answer</label>
              <textarea id="faqAnswer" style="min-height:120px;">We serve the greater metro area and nearby suburbs. Call with your address and we will confirm coverage.</textarea>
            </div>
          </div>
          <div class="toolbar" style="margin-top:10px;">
            <button class="btn brand" id="saveFaq">Save FAQ</button>
            <button class="btn" id="resetFaqForm">Reset</button>
          </div>
        </div>
      </section>

      <section id="team" class="screen">
        <div class="topbar"><h1>Team Users</h1><div class="top-actions"><button class="btn brand">Invite User</button></div></div>
        <div class="card">
          <table class="table">
            <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Status</th><th></th></tr></thead>
            <tbody id="teamUsersTable"></tbody>
          </table>
        </div>
      </section>

      <section id="routing" class="screen">
        <div class="topbar"><h1>Call Routing</h1><div class="top-actions"><button class="btn brand" id="saveRouting">Save Routing</button></div></div>
        <div class="grid cols-2">
          <div class="card">
            <label>Primary Callback Queue</label>
            <select id="routingPrimary"><option>Dispatch Team</option><option>Owner Only</option></select>
            <label style="margin-top:10px;">Emergency Calls</label>
            <select id="routingEmergency"><option>Immediate Transfer</option><option>Priority Queue</option></select>
          </div>
          <div class="card">
            <label>Business Hours</label>
            <textarea id="routingHours">Mon-Fri 7:00 AM - 8:00 PM\nEmergency service 24/7</textarea>
            <label style="margin-top:10px;">After Hours Behavior</label>
            <select id="routingAfterHours"><option>Collect details and dispatch callback</option><option>Forward to on-call</option></select>
          </div>
        </div>
      </section>

      <section id="settings" class="screen">
        <div class="topbar"><h1>Account Settings</h1></div>
        <div class="card">
          <div class="kv">
            <div>Tenant</div><div id="accountTenant">-</div>
            <div>Plan</div><div id="accountPlan">-</div>
            <div>Data Region</div><div id="accountRegion">-</div>
            <div>Audit Logs</div><div id="accountAudit">-</div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    const navBtns = [...document.querySelectorAll('.nav-btn')];
    const screens = [...document.querySelectorAll('.screen')];
    navBtns.forEach((btn) => {
      btn.addEventListener('click', () => {
        navBtns.forEach((b) => b.classList.remove('active'));
        btn.classList.add('active');
        const id = btn.dataset.screen;
        screens.forEach((s) => s.classList.toggle('active', s.id === id));
      });
    });

    const detail = document.getElementById('callDetail');
    const tenantKey = new URLSearchParams(window.location.search).get('tenantKey') || 'default';

    async function fetchJson(path, options = {}) {
      const resp = await fetch(path, options);
      if (!resp.ok) {
        const text = await resp.text();
        throw new Error(text || `Request failed (${resp.status})`);
      }
      return resp.json();
    }

    async function loadOverview() {
      const data = await fetchJson(`/v1/overview?tenantKey=${encodeURIComponent(tenantKey)}`);
      document.getElementById('statCalls').textContent = data.stats.callsToday;
      document.getElementById('statMissed').textContent = data.stats.missed;
      document.getElementById('statUrgent').textContent = data.stats.urgent;
      document.getElementById('statCallbacks').textContent = data.stats.callbacksDue;

      const recent = document.getElementById('recentCallsTable');
      recent.innerHTML = '';
      if (!data.recentCalls.length) {
        recent.innerHTML = '<tr><td colspan="4" class="muted">No recent calls.</td></tr>';
      } else {
        data.recentCalls.forEach((call) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${new Date(call.created_at).toLocaleTimeString()}</td>
            <td>${call.from_number || '-'}</td>
            <td><span class="badge ${call.urgency === 'high' ? 'warn' : call.status === 'error' ? 'bad' : 'ok'}">${call.urgency === 'high' ? 'Urgent' : call.status || 'Handled'}</span></td>
            <td>${call.summary || '-'}</td>
          `;
          recent.appendChild(row);
        });
      }

      const queue = document.getElementById('actionQueue');
      queue.innerHTML = '';
      if (!data.actionQueue.length) {
        queue.innerHTML = '<div class="muted">No callbacks due.</div>';
      } else {
        data.actionQueue.forEach((item) => {
          const name = document.createElement('div');
          name.textContent = item.caller_name || 'Caller';
          const summary = document.createElement('div');
          summary.textContent = item.summary || '';
          queue.appendChild(name);
          queue.appendChild(summary);
        });
      }
    }

    async function loadCalls() {
      const data = await fetchJson(`/v1/calls?tenantKey=${encodeURIComponent(tenantKey)}`);
      const tbody = document.getElementById('callsTableBody');
      tbody.innerHTML = '';
      if (!data.calls.length) {
        tbody.innerHTML = '<tr><td colspan="4" class="muted">No calls yet.</td></tr>';
        return;
      }
      data.calls.forEach((call) => {
        const row = document.createElement('tr');
        row.dataset.sid = call.call_sid;
        row.innerHTML = `
          <td>${call.call_sid}</td>
          <td>${call.from_number || '-'}</td>
          <td>${new Date(call.created_at).toLocaleString()}</td>
          <td><span class="badge ${call.status === 'error' ? 'bad' : 'ok'}">${call.status}</span></td>
        `;
        row.addEventListener('click', async () => {
          const detailJson = await fetchJson(`/v1/calls?tenantKey=${encodeURIComponent(tenantKey)}&callSid=${encodeURIComponent(call.call_sid)}`);
          detail.textContent = JSON.stringify(detailJson.call || {}, null, 2);
        });
        tbody.appendChild(row);
      });
    }

    async function loadDispatch() {
      const data = await fetchJson(`/v1/dispatch?tenantKey=${encodeURIComponent(tenantKey)}`);
      document.getElementById('dispatchNew').textContent = data.counts.new;
      document.getElementById('dispatchAssigned').textContent = data.counts.assigned;
      document.getElementById('dispatchClosed').textContent = data.counts.closed;
    }

    const faqTable = document.getElementById('faqTable');
    const faqStatus = document.getElementById('faqStatus');
    const faqQuestion = document.getElementById('faqQuestion');
    const faqAnswer = document.getElementById('faqAnswer');
    const faqCategory = document.getElementById('faqCategory');
    const saveFaq = document.getElementById('saveFaq');
    const resetFaqForm = document.getElementById('resetFaqForm');
    const industrySelect = document.getElementById('industrySelect');
    const seedIndustryFaqs = document.getElementById('seedIndustryFaqs');

    function setFaqStatus(message, tone) {
      faqStatus.textContent = message;
      faqStatus.style.color = tone === 'bad' ? '#dc2626' : tone === 'ok' ? '#059669' : '#475569';
    }

    async function loadFaqs() {
      setFaqStatus('Loading FAQs...', 'warn');
      const data = await fetchJson(`/v1/faq?tenantKey=${encodeURIComponent(tenantKey)}`);
      faqTable.innerHTML = '';
      if (!data.faqs.length) {
        faqTable.innerHTML = '<tr><td colspan="5" class="muted">No FAQs yet.</td></tr>';
        setFaqStatus('No FAQs found.', 'warn');
        return;
      }
      data.faqs.forEach((faq) => {
        const row = document.createElement('tr');
        row.dataset.id = faq.id;
        row.dataset.deletable = String(Boolean(faq.deletable));
        row.innerHTML = `
          <td>${faq.question}</td>
          <td>${faq.answer}</td>
          <td>${faq.category}</td>
          <td>${faq.updated_at ? new Date(faq.updated_at).toLocaleString() : ''}</td>
          <td>
            <input type="hidden" value="${faq.deletable ? '1' : '0'}" />
            <button class="btn delete-faq"${faq.deletable ? '' : ' disabled'}>Delete</button>
          </td>
        `;
        faqTable.appendChild(row);
      });

      faqTable.querySelectorAll('.delete-faq').forEach((btn) => {
        btn.addEventListener('click', async (e) => {
          const row = e.target.closest('tr');
          if (!row || row.dataset.deletable !== 'true') {
            return;
          }
          await fetchJson(`/v1/faq?tenantKey=${encodeURIComponent(tenantKey)}&id=${row.dataset.id}`, { method: 'DELETE' });
          await loadFaqs();
          setFaqStatus('Deleted FAQ.', 'ok');
        });
      });
      setFaqStatus('Loaded FAQs.', 'ok');
    }

    async function addIndustryDefaults() {
      const industry = industrySelect.value || 'general';
      const resp = await fetchJson('/v1/faq', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tenantKey, action: 'seedIndustry', industry })
      });
      await loadFaqs();
      setFaqStatus(`Added ${resp.added} industry FAQs.`, 'ok');
    }

    function resetForm() {
      faqQuestion.value = '';
      faqAnswer.value = '';
      faqCategory.value = '';
    }

    saveFaq.addEventListener('click', async () => {
      const question = faqQuestion.value.trim();
      const answer = faqAnswer.value.trim();
      const category = faqCategory.value.trim() || 'General';
      if (!question || !answer) {
        setFaqStatus('Question and answer are required.', 'bad');
        return;
      }
      await fetchJson('/v1/faq', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tenantKey, question, answer, category })
      });
      resetForm();
      await loadFaqs();
      setFaqStatus('FAQ saved.', 'ok');
    });

    resetFaqForm.addEventListener('click', resetForm);
    seedIndustryFaqs.addEventListener('click', addIndustryDefaults);
    document.getElementById('addFaqBtn').addEventListener('click', () => faqQuestion.focus());

    async function loadTeamUsers() {
      const data = await fetchJson(`/v1/tenant/users?tenantKey=${encodeURIComponent(tenantKey)}`);
      const tbody = document.getElementById('teamUsersTable');
      tbody.innerHTML = '';
      if (!data.users.length) {
        tbody.innerHTML = '<tr><td colspan="5" class="muted">No users yet.</td></tr>';
        return;
      }
      data.users.forEach((user) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${user.name}</td>
          <td>${user.email}</td>
          <td>${user.role}</td>
          <td><span class="badge ${user.status === 'active' ? 'ok' : 'warn'}">${user.status}</span></td>
          <td><button class="btn">Manage</button></td>
        `;
        tbody.appendChild(row);
      });
    }

    async function loadRouting() {
      const data = await fetchJson(`/v1/routing?tenantKey=${encodeURIComponent(tenantKey)}`);
      if (!data.routing) {
        return;
      }
      document.getElementById('routingPrimary').value = data.routing.primary_queue;
      document.getElementById('routingEmergency').value = data.routing.emergency_behavior;
      document.getElementById('routingAfterHours').value = data.routing.after_hours_behavior;
      document.getElementById('routingHours').value = data.routing.business_hours;
    }

    document.getElementById('saveRouting').addEventListener('click', async () => {
      await fetchJson('/v1/routing', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          tenantKey,
          primaryQueue: document.getElementById('routingPrimary').value,
          emergencyBehavior: document.getElementById('routingEmergency').value,
          afterHoursBehavior: document.getElementById('routingAfterHours').value,
          businessHours: document.getElementById('routingHours').value
        })
      });
    });

    async function loadSettings() {
      const data = await fetchJson(`/v1/settings?tenantKey=${encodeURIComponent(tenantKey)}`);
      document.getElementById('accountTenant').textContent = data.tenant?.name || '-';
      document.getElementById('tenantName').textContent = data.tenant?.name || 'Tenant';
      document.getElementById('accountPlan').textContent = data.tenant?.plan || '-';
      document.getElementById('accountRegion').textContent = data.tenant?.data_region || '-';
      document.getElementById('accountAudit').textContent = data.settings?.notes ? 'Enabled' : 'Disabled';
    }

    Promise.all([
      loadOverview(),
      loadCalls(),
      loadDispatch(),
      loadFaqs(),
      loadTeamUsers(),
      loadRouting(),
      loadSettings()
    ]).catch(() => {});
  </script>
</body>
</html>
